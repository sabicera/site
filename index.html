<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="style.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
</head>
<body>
    <div id="map"></div>
    <div id="search-container">
        <input type="text" id="search-box" placeholder="Enter city, port, airport, or country">
        <button id="search-button">Search</button>
    </div>

    <script>
        var map = L.map('map').setView([10, -30], 3); // Set initial view to show the entire world

        // Add a Carto tile layer to the map with English labels
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            maxZoom: 18
        }).addTo(map);

        var markers = [];

    // Function to create a marker with mouseover and click events
    function createMarker(lat, lon, popupContent, phoneNumber) {
        var marker = L.marker([lat, lon]).addTo(map);
        var whatsappUrl = `https://wa.me/${phoneNumber}`;
        
        // Replace new lines with HTML line breaks for display
        var formattedPopupContent = popupContent
            .replace(/\n/g, '<br>');  // Replace new lines with <br> for HTML
        
        // Escape single quotes for JavaScript string handling
        var escapedPopupContent = popupContent.replace(/'/g, "\\'").replace(/\n/g, '\\n');
        
        var updatedPopupContent = `
            <div>
                ${formattedPopupContent}
                <br><b>Contact:</b> <a href="${whatsappUrl}" target="_blank">${phoneNumber}</a>
                <br><button onclick="copyToClipboard('${escapedPopupContent}')">
                    <img src="../icons/copy.png" alt="Copy" style="width:16px;height:16px;"/>
                </button>
            </div>
        `;
        
        marker.bindPopup(updatedPopupContent);

        marker.on('mouseover', function() {
            marker.openPopup();
        });

        marker.on('mouseout', function() {
            if (!marker.isPopupOpen()) {
                marker.closePopup();
            }
        });

        marker.on('click', function() {
            marker.openPopup();
            marker.off('mouseout');
        });

        return marker;
    }

        // Fetch agents data from JSON file and create markers
        fetch('agents.json')
            .then(response => response.json())
            .then(data => {
                data.forEach(agent => {
                    var marker = createMarker(agent.lat, agent.lon, `<b>${agent.name}</b><br>${agent.details}`, agent.phone);
                    markers.push(marker);
                });
            })
            .catch(error => {
                console.error('Error fetching agents data:', error);
            });

        document.getElementById('search-button').addEventListener('click', function() {
            var query = document.getElementById('search-box').value.toLowerCase();
            var found = false;

            markers.forEach(function(marker) {
                var popupContent = marker.getPopup().getContent().toLowerCase();
                if (popupContent.includes(query)) {
                    map.setView(marker.getLatLng(), 10);
                    marker.openPopup();
                    found = true;
                }
            });

            if (!found) {
                alert('Location not found');
            }
        });

    // Function to copy HTML content as plain text to clipboard
    function copyToClipboard(html) {
        // Create a temporary div element to parse HTML
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;

        // Convert HTML to plain text with line breaks
        var text = tempDiv.innerText || tempDiv.textContent || "";

        // Create a temporary textarea element
        var textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);

        // Select the text and copy it to the clipboard
        textarea.select();
        document.execCommand('copy');

        // Clean up: remove the temporary textarea
        document.body.removeChild(textarea);
    }
    </script>
</body>
</html>
