<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureMS Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #4CAF50, #45c213);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header p {
            color: #888;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .stat-card .value {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stat-card .label {
            color: #888;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-card.green .value { color: #4CAF50; }
        .stat-card.blue .value { color: #2196F3; }
        .stat-card.orange .value { color: #FF9800; }
        .stat-card.purple .value { color: #9C27B0; }
        .stat-card.red .value { color: #f44336; }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chart-card h3 {
            margin-bottom: 20px;
            color: #fff;
        }
        
        .table-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow-x: auto;
        }
        
        .table-container h3 {
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-success { background: rgba(76, 175, 80, 0.2); color: #4CAF50; }
        .status-partial { background: rgba(255, 152, 0, 0.2); color: #FF9800; }
        .status-failed { background: rgba(244, 67, 54, 0.2); color: #f44336; }
        
        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1rem;
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .refresh-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 30px rgba(76, 175, 80, 0.5);
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #888;
        }
        
        .last-updated {
            text-align: center;
            color: #666;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        /* Configuration panel */
        .config-panel {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid #FF9800;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .config-panel h3 {
            color: #FF9800;
            margin-bottom: 15px;
        }
        
        .config-panel input {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #444;
            background: #1a1a2e;
            color: #fff;
            margin-bottom: 10px;
        }
        
        .config-panel button {
            background: #FF9800;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä SecureMS Analytics</h1>
        <p>Real-time usage tracking dashboard</p>
    </div>
    
    <!-- Configuration Panel (shown if not configured) -->
    <div class="config-panel" id="configPanel">
        <h3>‚öôÔ∏è Setup Required</h3>
        <p style="margin-bottom: 15px; color: #ccc;">Enter your Google Sheet ID or full URL to connect the dashboard:</p>
        <input type="text" id="sheetIdInput" placeholder="Sheet ID or full Google Sheets URL">
        <p style="margin-bottom: 10px; color: #888; font-size: 0.85rem;">
            <strong>Option 1:</strong> Paste the Sheet ID from URL: docs.google.com/spreadsheets/d/<span style="color: #4CAF50; background: rgba(76,175,80,0.2); padding: 2px 6px; border-radius: 3px;">THIS_PART</span>/edit
        </p>
        <p style="margin-bottom: 15px; color: #888; font-size: 0.85rem;">
            <strong>Option 2:</strong> Paste the full Google Sheets URL
        </p>
        <p style="margin-bottom: 15px; color: #FF9800; font-size: 0.85rem;">
            ‚ö†Ô∏è <strong>Important:</strong> The Google Sheet must be shared as "Anyone with the link can view"
        </p>
        <button onclick="saveConfig()">Connect Dashboard</button>
    </div>
    
    <!-- Stats Overview -->
    <div class="stats-grid" id="statsGrid">
        <div class="stat-card green">
            <div class="value" id="totalFiles">-</div>
            <div class="label">Files Processed</div>
        </div>
        <div class="stat-card blue">
            <div class="value" id="totalUsers">-</div>
            <div class="label">Active Users</div>
        </div>
        <div class="stat-card orange">
            <div class="value" id="todayFiles">-</div>
            <div class="label">Today's Files</div>
        </div>
        <div class="stat-card purple">
            <div class="value" id="successRate">-</div>
            <div class="label">Success Rate</div>
        </div>
    </div>
    
    <!-- Charts -->
    <div class="charts-container">
        <div class="chart-card">
            <h3>üìà Daily Usage (Last 7 Days)</h3>
            <canvas id="dailyChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>üìä Event Types</h3>
            <canvas id="eventChart"></canvas>
        </div>
    </div>
    
    <!-- Recent Activity Table -->
    <div class="table-container">
        <h3>üïê Recent Activity</h3>
        <table>
            <thead>
                <tr>
                    <th>Time</th>
                    <th>User</th>
                    <th>Event</th>
                    <th>Files</th>
                    <th>Status</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody id="activityTable">
                <tr><td colspan="6" class="loading">Loading data...</td></tr>
            </tbody>
        </table>
    </div>
    
    <p class="last-updated">Last updated: <span id="lastUpdated">-</span></p>
    
    <button class="refresh-btn" onclick="loadData()">üîÑ Refresh</button>
    
    <script>
        // Configuration
        let SHEET_ID = localStorage.getItem('sheetId') || '1FHrBYROT4X0XxX6QUi68R6iHwVmhgVKm7bRTwjXPBGg';
        const SHEET_NAME = 'Form Responses'; // Default Google Form response sheet name
        
        // Check if configured
        function checkConfig() {
            if (!SHEET_ID) {
                document.getElementById('configPanel').style.display = 'block';
                document.getElementById('statsGrid').style.opacity = '0.3';
            } else {
                document.getElementById('configPanel').style.display = 'none';
                document.getElementById('statsGrid').style.opacity = '1';
                loadData();
            }
        }
        
        function saveConfig() {
            const sheetId = document.getElementById('sheetIdInput').value.trim();
            if (sheetId) {
                localStorage.setItem('sheetId', sheetId);
                SHEET_ID = sheetId;
                checkConfig();
            }
        }
        
        // Charts
        let dailyChart, eventChart;
        
        function initCharts() {
            const ctx1 = document.getElementById('dailyChart').getContext('2d');
            dailyChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Files Processed',
                        data: [],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
            
            const ctx2 = document.getElementById('eventChart').getContext('2d');
            eventChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['PDF Conversion', 'ZIP Creation', 'App Starts', 'Updates'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#4CAF50', '#FF9800', '#2196F3', '#9C27B0']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } }
                }
            });
        }
        
        // Load data from Google Sheets
        async function loadData() {
            if (!SHEET_ID) return;
            
            // Clean the Sheet ID (remove any URL parts if user pasted full URL)
            let cleanSheetId = SHEET_ID;
            if (SHEET_ID.includes('spreadsheets/d/')) {
                const match = SHEET_ID.match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                if (match) cleanSheetId = match[1];
            }
            if (SHEET_ID.includes('/edit')) {
                cleanSheetId = cleanSheetId.split('/edit')[0];
            }
            
            try {
                // Google Sheets API (public sheet required)
            const url = `https://docs.google.com/spreadsheets/d/${cleanSheetId}/gviz/tq?tqx=out:json&gid=1747590123`;                
                console.log('Fetching:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Sheet not found or not public`);
                }
                
                const text = await response.text();
                
                // Check if we got an error page instead of data
                if (text.includes('<!DOCTYPE html>') || text.includes('<html')) {
                    throw new Error('Sheet not found or not shared publicly. Please check sharing settings.');
                }
                
                // Parse Google's JSON response (wrapped in callback)
                const jsonStart = text.indexOf('{');
                const jsonEnd = text.lastIndexOf('}');
                
                if (jsonStart === -1 || jsonEnd === -1) {
                    throw new Error('Invalid response from Google Sheets. Make sure the sheet is public.');
                }
                
                const json = JSON.parse(text.substring(jsonStart, jsonEnd + 1));
                
                if (!json.table || !json.table.rows) {
                    throw new Error('No data found in sheet. Make sure the form has responses.');
                }
                
                const rows = json.table.rows;
                const headers = json.table.cols.map(col => col.label);
                
                // Process data
                processData(rows, headers);
                
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('activityTable').innerHTML = 
                    `<tr><td colspan="6" style="color: #f44336;">
                        <strong>Error:</strong> ${error.message}<br><br>
                        <strong>Troubleshooting:</strong><br>
                        1. Make sure the Google Sheet is shared as "Anyone with the link can view"<br>
                        2. Check that you entered the correct Sheet ID<br>
                        3. The Sheet ID is the long string in the URL between /d/ and /edit
                    </td></tr>`;
            }
        }
        
        function processData(rows, headers) {
            console.log('Headers found:', headers);
            
            // Find column indices - Google Forms uses the question text as headers
            // Map by index position (Timestamp is always first, then questions in order)
            const colIndex = {
                time: 0,        // Timestamp (auto-added by Google Forms)
                machine: 1,     // machine_id
                version: 2,     // version
                event: 3,       // event_type
                files: 4,       // file_count
                status: 5,      // status
                timestamp: 6,   // timestamp (our custom one)
                details: 7      // details
            };
            
            // Try to detect columns by header name if available
            headers.forEach((h, i) => {
                if (!h) return;
                const lower = h.toLowerCase();
                if (lower.includes('machine')) colIndex.machine = i;
                if (lower.includes('version') && !lower.includes('event')) colIndex.version = i;
                if (lower.includes('event')) colIndex.event = i;
                if (lower.includes('file') && lower.includes('count')) colIndex.files = i;
                if (lower.includes('status')) colIndex.status = i;
                if (lower === 'timestamp' || lower.includes('timestamp')) {
                    if (i === 0) colIndex.time = i;
                    else colIndex.timestamp = i;
                }
                if (lower.includes('detail')) colIndex.details = i;
            });
            
            console.log('Column mapping:', colIndex);
            
            // Calculate stats
            let totalFiles = 0;
            let todayFiles = 0;
            let successCount = 0;
            let totalEvents = 0;
            const uniqueUsers = new Set();
            const dailyData = {};
            const eventCounts = { pdf: 0, zip: 0, start: 0, update: 0 };
            const today = new Date().toDateString();
            
            // Process each row
            const activities = [];
            
            rows.forEach(row => {
                if (!row.c) return;
                
                const getValue = (idx) => row.c[idx]?.v || '';
                
                const machineId = getValue(colIndex.machine);
                const eventType = getValue(colIndex.event);
                const fileCount = parseInt(getValue(colIndex.files)) || 0;
                const status = getValue(colIndex.status);
                const details = getValue(colIndex.details);
                
                if (machineId) uniqueUsers.add(machineId);
                
                totalFiles += fileCount;
                totalEvents++;
                
                if (status === 'success' || status === 'partial') successCount++;
                
                // Parse date - handle Google Forms timestamp format
                let date = null;
                const timeValue = getValue(colIndex.time);
                
                if (timeValue) {
                    // Google Sheets returns dates as "Date(year,month,day,hour,min,sec)"
                    if (typeof timeValue === 'string' && timeValue.startsWith('Date(')) {
                        const match = timeValue.match(/Date\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/);
                        if (match) {
                            date = new Date(match[1], match[2], match[3], match[4], match[5], match[6]);
                        }
                    } else if (typeof timeValue === 'object' && timeValue.v) {
                        // Handle Google's date object format
                        const v = timeValue.v;
                        if (typeof v === 'string' && v.startsWith('Date(')) {
                            const match = v.match(/Date\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/);
                            if (match) {
                                date = new Date(match[1], match[2], match[3], match[4], match[5], match[6]);
                            }
                        }
                    } else if (typeof timeValue === 'string') {
                        date = new Date(timeValue);
                    }
                }
                
                // Fallback to row's formatted time if available
                if (!date && row.c[colIndex.time]?.f) {
                    date = new Date(row.c[colIndex.time].f);
                }
                
                if (date) {
                    const dateStr = date.toDateString();
                    if (dateStr === today) todayFiles += fileCount;
                    
                    const dayKey = date.toISOString().split('T')[0];
                    dailyData[dayKey] = (dailyData[dayKey] || 0) + fileCount;
                }
                
                // Event types
                if (eventType.includes('pdf')) eventCounts.pdf++;
                else if (eventType.includes('zip')) eventCounts.zip++;
                else if (eventType.includes('start')) eventCounts.start++;
                else if (eventType.includes('update')) eventCounts.update++;
                
                // Recent activities
                activities.push({
                    time: date ? date.toLocaleString() : 'N/A',
                    user: machineId?.substring(0, 8) || '-',
                    event: eventType || '-',
                    files: fileCount,
                    status: status || '-',
                    details: details || '-'
                });
            });
            
            // Update stats
            document.getElementById('totalFiles').textContent = totalFiles.toLocaleString();
            document.getElementById('totalUsers').textContent = uniqueUsers.size;
            document.getElementById('todayFiles').textContent = todayFiles.toLocaleString();
            document.getElementById('successRate').textContent = 
                totalEvents > 0 ? Math.round((successCount / totalEvents) * 100) + '%' : '-';
            
            // Update daily chart
            const last7Days = [];
            const last7Values = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const key = d.toISOString().split('T')[0];
                last7Days.push(d.toLocaleDateString('en', { weekday: 'short' }));
                last7Values.push(dailyData[key] || 0);
            }
            
            dailyChart.data.labels = last7Days;
            dailyChart.data.datasets[0].data = last7Values;
            dailyChart.update();
            
            // Update event chart
            eventChart.data.datasets[0].data = [
                eventCounts.pdf,
                eventCounts.zip,
                eventCounts.start,
                eventCounts.update
            ];
            eventChart.update();
            
            // Update activity table (last 20)
            const tableBody = document.getElementById('activityTable');
            tableBody.innerHTML = activities.slice(-20).reverse().map(a => `
                <tr>
                    <td>${a.time}</td>
                    <td>${a.user}...</td>
                    <td>${a.event}</td>
                    <td>${a.files}</td>
                    <td><span class="status-badge status-${a.status}">${a.status}</span></td>
                    <td>${a.details}</td>
                </tr>
            `).join('');
        }
        
        // Initialize
        initCharts();
        checkConfig();
        
        // Auto-refresh every 5 minutes
        setInterval(loadData, 5 * 60 * 1000);
    </script>
</body>
</html>
